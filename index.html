<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ROF BETA v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .view { display: none; }
        .view.active { display: block; padding-bottom: 80px; }
        .nav-active { color: #ef4444; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 flex justify-center">

    <div class="w-full max-w-[500px] bg-white min-h-screen shadow-2xl relative">
        
        <header class="sticky top-0 bg-white border-b p-4 flex justify-between items-center z-50">
            <h1 class="text-3xl font-black italic text-red-600 cursor-pointer" onclick="switchTab('home')">ROF</h1>
            <div id="top-icons" class="flex gap-4 items-center">
                <button onclick="switchTab('settings')"><i class="fa-solid fa-gear text-xl text-gray-400"></i></button>
            </div>
        </header>

        <section id="home" class="view active">
            <div id="feed" class="divide-y"></div>
        </section>

        <section id="explore" class="view">
            <div class="p-4">
                <div class="bg-gray-100 flex items-center p-3 rounded-2xl mb-4">
                    <i class="fa fa-search text-gray-400 mr-2"></i>
                    <input type="text" id="searchInput" onkeyup="liveSearch(this.value)" placeholder="Kullanıcı adı yaz (a...)" class="bg-transparent outline-none w-full">
                </div>
                <div id="search-results" class="divide-y"></div>
            </div>
        </section>

        <section id="user-profile" class="view">
            <div class="p-6">
                <button onclick="switchTab('explore')" class="mb-4 text-gray-500"><i class="fa fa-arrow-left"></i> Geri</button>
                <div id="target-profile-content"></div>
            </div>
        </section>

        <section id="settings" class="view">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-6">Hesap Ayarları</h2>
                <button onclick="handleLogout()" class="w-full bg-gray-100 p-4 rounded-xl font-bold text-left mb-3">
                    <i class="fa-solid fa-right-from-bracket mr-2 text-red-500"></i> Çıkış Yap
                </button>
                <button onclick="handleDeleteAccount()" class="w-full bg-red-50 p-4 rounded-xl font-bold text-left text-red-600">
                    <i class="fa-solid fa-trash-can mr-2"></i> Hesabı Tamamen Sil
                </button>
            </div>
        </section>

        <nav class="fixed bottom-0 w-full max-w-[500px] bg-white border-t flex justify-around p-4 shadow-lg">
            <button onclick="switchTab('home')" class="nav-active"><i class="fa-solid fa-house text-2xl"></i></button>
            <button onclick="switchTab('explore')"><i class="fa-solid fa-magnifying-glass text-2xl"></i></button>
            <button onclick="switchTab('home')"><i class="fa-solid fa-square-plus text-2xl"></i></button>
            <button onclick="viewMyProfile()"><i class="fa-solid fa-user text-2xl"></i></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTHfXRbJaUcN0ng-ik0B-N4Ai8pnnKiIk",
            authDomain: "rate-of-fire-rof.firebaseapp.com",
            projectId: "rate-of-fire-rof",
            storageBucket: "rate-of-fire-rof.firebasestorage.app",
            messagingSenderId: "706117316470",
            appId: "1:706117316470:web:833f1abf5994f96c0b5457"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, { uid: user.uid, name: user.displayName, photo: user.photoURL, followers: [], following: [], bio: "Yeni ROF Üyesi" });
                }
                loadFeed();
            } else {
                signInWithPopup(auth, provider);
            }
        });

        // SEKME YÖNETİMİ
        window.switchTab = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // GELİŞMİŞ CANLI ARAMA
        window.liveSearch = async (val) => {
            const resultsDiv = document.getElementById('search-results');
            if (val.length < 1) { resultsDiv.innerHTML = ""; return; }

            const q = query(collection(db, "users"), where("name", ">=", val), where("name", "<=", val + '\uf8ff'));
            const querySnapshot = await getDocs(q);
            
            resultsDiv.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.uid === currentUser.uid) return;
                resultsDiv.innerHTML += `
                    <div onclick="viewUser('${data.uid}')" class="flex items-center gap-4 p-4 hover:bg-gray-50 cursor-pointer">
                        <img src="${data.photo}" class="w-12 h-12 rounded-full border">
                        <div>
                            <p class="font-bold text-sm">${data.name}</p>
                            <p class="text-xs text-gray-500">Profili gör</p>
                        </div>
                    </div>`;
            });
        };

        // BAŞKA PROFİLİ GÖRÜNTÜLEME
        window.viewUser = async (uid) => {
            const userSnap = await getDoc(doc(db, "users", uid));
            const data = userSnap.data();
            const mySnap = await getDoc(doc(db, "users", currentUser.uid));
            const myData = mySnap.data();
            const isFollowing = myData.following.includes(uid);

            const content = document.getElementById('target-profile-content');
            content.innerHTML = `
                <div class="text-center">
                    <img src="${data.photo}" class="w-24 h-24 rounded-full mx-auto border-4 border-red-500 p-1 mb-4">
                    <h2 class="text-2xl font-black">${data.name}</h2>
                    <p class="text-gray-500 mb-6">${data.bio || ''}</p>
                    <div class="flex gap-2 justify-center">
                        <button onclick="toggleFollow('${uid}', ${isFollowing})" class="px-8 py-2 rounded-xl font-bold ${isFollowing ? 'bg-gray-200' : 'bg-red-600 text-white'}">
                            ${isFollowing ? 'Takiptesin' : 'Takip Et'}
                        </button>
                        <button onclick="alert('Mesaj özelliği Beta yakında!')" class="bg-black text-white px-8 py-2 rounded-xl font-bold">Mesaj</button>
                    </div>
                </div>
            `;
            switchTab('user-profile');
        };

        // TAKİP ETME MANTIĞI
        window.toggleFollow = async (targetUid, isFollowing) => {
            const myRef = doc(db, "users", currentUser.uid);
            const targetRef = doc(db, "users", targetUid);
            if (isFollowing) {
                await updateDoc(myRef, { following: arrayRemove(targetUid) });
                await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(myRef, { following: arrayUnion(targetUid) });
                await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
            }
            viewUser(targetUid);
        };

        // HESAP İŞLEMLERİ
        window.handleLogout = () => signOut(auth).then(() => location.reload());
        window.handleDeleteAccount = async () => {
            if (confirm("DİKKAT! Hesabın ve tüm verilerin silinecek. Emin misin?")) {
                await deleteUser(auth.currentUser);
                location.reload();
            }
        };

        function loadFeed() {
            const q = query(collection(db, "posts"), orderBy("time", "desc"));
            onSnapshot(q, (snaps) => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                snaps.forEach(s => {
                    const d = s.data();
                    feed.innerHTML += `
                        <div class="p-4 bg-white border-b">
                            <div class="flex items-center gap-2 mb-3" onclick="viewUser('${d.uid}')">
                                <img src="${d.photo}" class="w-8 h-8 rounded-full">
                                <span class="font-bold text-sm cursor-pointer">${d.name}</span>
                            </div>
                            <p class="text-sm">${d.text}</p>
                            ${d.image ? `<img src="${d.image}" class="w-full rounded-xl mt-3 shadow-sm border">` : ''}
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>

