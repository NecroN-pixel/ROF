
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROF ULTRA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #000; color: white; font-family: -apple-system, sans-serif; }
        .app-shell { max-width: 500px; margin: 0 auto; min-height: 100vh; background: #000; border-inline: 1px solid #222; position: relative; padding-bottom: 80px; }
        .view { display: none; }
        .view.active { display: block; }
        .nav-active { color: #f87171 !important; }
        ::-webkit-scrollbar { display: none; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="app-shell">
    <header class="sticky top-0 bg-black/80 backdrop-blur z-50 p-4 border-b border-gray-800 flex justify-between items-center">
        <h1 class="text-2xl font-black italic tracking-tighter text-white" onclick="location.reload()">ROF</h1>
        <div class="flex gap-4">
            <i class="fa-regular fa-bell text-xl"></i>
            <button onclick="handleDeleteAccount()" class="text-red-500 text-xs border border-red-900 px-2 py-1 rounded">Hesabı Sil</button>
        </div>
    </header>

    <section id="view-home" class="view active">
        <div class="p-4 border-b border-gray-800 flex gap-3">
            <img id="my-avatar" class="w-10 h-10 rounded-full border border-gray-700">
            <div class="flex-1">
                <textarea id="tweet-text" placeholder="Neler oluyor?" class="w-full bg-transparent border-none outline-none text-lg resize-none" rows="2"></textarea>
                <div id="preview-box" class="hidden relative mt-2">
                    <img id="img-output" class="w-full rounded-xl border border-gray-700">
                    <button onclick="clearImage()" class="absolute top-2 right-2 bg-black/50 p-1 rounded-full">✕</button>
                </div>
                <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-900">
                    <label class="cursor-pointer text-red-500 hover:text-red-400">
                        <i class="fa-regular fa-image text-xl"></i>
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="processImage(event)">
                    </label>
                    <button onclick="sendPost()" class="bg-red-600 text-white px-6 py-1.5 rounded-full font-bold text-sm">Paylaş</button>
                </div>
            </div>
        </div>
        <div id="feed"></div>
    </section>

    <section id="view-profile" class="view">
        <div id="profile-header" class="p-5 border-b border-gray-800"></div>
        <div id="profile-grid" class="grid grid-cols-3 gap-0.5"></div>
    </section>

    <nav class="fixed bottom-0 w-full max-w-[500px] bg-black border-t border-gray-800 flex justify-around p-4 z-50">
        <button onclick="changeTab('home', this)" class="nav-active"><i class="fa-solid fa-house text-2xl"></i></button>
        <button onclick="alert('Arama aktif!')"><i class="fa-solid fa-magnifying-glass text-2xl text-gray-500"></i></button>
        <button onclick="document.getElementById('tweet-text').focus(); changeTab('home')"><i class="fa-solid fa-square-plus text-3xl text-red-600"></i></button>
        <button onclick="alert('Beğeni')"><i class="fa-regular fa-heart text-2xl text-gray-500"></i></button>
        <button onclick="loadProfile(auth.currentUser.uid, this)"><img id="nav-avatar" class="w-7 h-7 rounded-full border border-gray-700"></button>
    </nav>
</div>

<div id="modal-detail" class="modal-overlay" onclick="this.style.display='none'">
    <div class="bg-gray-900 w-full rounded-2xl p-4 overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
        <div id="detail-content"></div>
        <div class="mt-4 border-t border-gray-800 pt-4">
            <h3 class="font-bold mb-3">Yorumlar</h3>
            <div id="detail-comments" class="space-y-3 mb-4 max-h-40 overflow-y-auto"></div>
            <div class="flex gap-2">
                <input type="text" id="comment-input" class="flex-1 bg-black border border-gray-800 p-2 rounded-lg outline-none" placeholder="Yorum yaz...">
                <button id="comment-btn" class="text-red-500 font-bold">Gönder</button>
            </div>
        </div>
    </div>
</div>

<canvas id="compress-canvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCTHfXRbJaUcN0ng-ik0B-N4Ai8pnnKiIk",
        authDomain: "rate-of-fire-rof.firebaseapp.com",
        projectId: "rate-of-fire-rof",
        storageBucket: "rate-of-fire-rof.firebasestorage.app",
        messagingSenderId: "706117316470",
        appId: "1:706117316470:web:833f1abf5994f96c0b5457"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let userData = null;
    let currentImage = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const ref = doc(db, "users", user.uid);
            const snap = await getDoc(ref);
            if (!snap.exists() || !snap.data().name) {
                userData = { uid: user.uid, name: user.displayName, photo: user.photoURL, following: [], followers: [] };
                await setDoc(ref, userData);
            } else { userData = snap.data(); }
            document.getElementById('my-avatar').src = userData.photo;
            document.getElementById('nav-avatar').src = userData.photo;
            loadFeed();
        } else { signInWithPopup(auth, provider); }
    });

    // --- GÖRSEL KÜÇÜLTME SİSTEMİ ---
    window.processImage = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.getElementById('compress-canvas');
                const ctx = canvas.getContext('2d');
                let width = img.width;
                let height = img.height;
                const max = 800; // Max boyut
                if (width > height && width > max) { height *= max / width; width = max; }
                else if (height > max) { width *= max / height; height = max; }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                currentImage = canvas.toDataURL('image/jpeg', 0.6); // %60 kaliteye düşürür
                document.getElementById('img-output').src = currentImage;
                document.getElementById('preview-box').classList.remove('hidden');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    window.clearImage = () => { currentImage = null; document.getElementById('preview-box').classList.add('hidden'); };

    // --- POST GÖNDERME ---
    window.sendPost = async () => {
        const text = document.getElementById('tweet-text').value;
        if (!text && !currentImage) return;
        await addDoc(collection(db, "posts"), {
            uid: userData.uid, name: userData.name, photo: userData.photo,
            text, image: currentImage, likes: [], comments: [], time: serverTimestamp()
        });
        document.getElementById('tweet-text').value = "";
        clearImage();
    };

    // --- AKIŞ VE DETAY ---
    function loadFeed() {
        onSnapshot(query(collection(db, "posts"), orderBy("time", "desc")), (snaps) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            snaps.forEach(s => {
                const p = s.data();
                feed.innerHTML += `
                <div class="border-b border-gray-900 p-4" onclick="openDetail('${s.id}')">
                    <div class="flex items-center gap-3 mb-3">
                        <img src="${p.photo}" class="w-9 h-9 rounded-full">
                        <b class="text-sm">${p.name}</b>
                    </div>
                    <p class="text-gray-200 mb-3">${p.text}</p>
                    ${p.image ? `<img src="${p.image}" class="w-full rounded-xl border border-gray-800">` : ''}
                    <div class="flex gap-6 mt-4 text-gray-500">
                        <span><i class="fa-regular fa-heart"></i> ${p.likes.length}</span>
                        <span><i class="fa-regular fa-comment"></i> ${p.comments.length}</span>
                    </div>
                </div>`;
            });
        });
    }

    window.openDetail = async (id) => {
        const p = (await getDoc(doc(db, "posts", id))).data();
        const detail = document.getElementById('detail-content');
        const commList = document.getElementById('detail-comments');
        document.getElementById('modal-detail').style.display = 'flex';
        
        detail.innerHTML = `
            <div class="flex items-center gap-3 mb-4">
                <img src="${p.photo}" class="w-10 h-10 rounded-full">
                <b class="text-lg">${p.name}</b>
            </div>
            <p class="text-white text-xl mb-4">${p.text}</p>
            ${p.image ? `<img src="${p.image}" class="w-full rounded-xl mb-4">` : ''}
        `;

        commList.innerHTML = p.comments.map(c => `<p class="text-sm"><b>${c.user}:</b> ${c.text}</p>`).join('');

        document.getElementById('comment-btn').onclick = async () => {
            const val = document.getElementById('comment-input').value;
            if(!val) return;
            await updateDoc(doc(db, "posts", id), { comments: arrayUnion({ user: userData.name, text: val }) });
            document.getElementById('comment-input').value = "";
            openDetail(id); // Yenile
        };
    };

    // --- PROFİL ---
    window.loadProfile = async (uid, el) => {
        changeTab('profile', el);
        const u = (await getDoc(doc(db, "users", uid))).data();
        document.getElementById('profile-header').innerHTML = `
            <div class="flex items-center gap-6 mb-4">
                <img src="${u.photo}" class="w-20 h-20 rounded-full border-2 border-red-600 p-1">
                <div>
                    <h2 class="text-2xl font-bold">${u.name}</h2>
                    <p class="text-gray-500">@${u.name.toLowerCase().replace(/\s/g, '')}</p>
                </div>
            </div>
        `;
        const q = query(collection(db, "posts"), where("uid", "==", uid));
        const snaps = await getDocs(q);
        const grid = document.getElementById('profile-grid');
        grid.innerHTML = "";
        snaps.forEach(s => {
            if(s.data().image) grid.innerHTML += `<img src="${s.data().image}" onclick="openDetail('${s.id}')" class="aspect-square object-cover w-full">`;
        });
    };

    window.handleDeleteAccount = async () => {
        if(confirm("DİKKAT! Tüm verilerin silinecek. Onaylıyor musun?")) {
            await deleteDoc(doc(db, "users", auth.currentUser.uid));
            await deleteUser(auth.currentUser);
            location.reload();
        }
    };

    window.changeTab = (id, el) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
        if(el) el.classList.add('nav-active');
    };

</script>
</body>
</html>
