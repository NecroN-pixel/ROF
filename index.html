<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROF | ULTIMATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --whatsapp-green: #25D366; --rof-bg: #000; }
        body { background: var(--rof-bg); color: white; font-family: sans-serif; overflow-x: hidden; }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Inputs */
        input, textarea { background: #121b22; border: 1px solid #222e35; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        input:focus { border-color: var(--whatsapp-green); }
        
        /* Chat Design */
        .chat-bubble { padding: 8px 12px; border-radius: 12px; max-width: 80%; margin-bottom: 4px; }
        .bubble-me { background: #005c4b; margin-left: auto; border-bottom-right-radius: 2px; }
        .bubble-you { background: #202c33; margin-right: auto; border-bottom-left-radius: 2px; }

        /* Onboarding Overlays */
        #onboarding-overlay, #error-toast { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; padding: 20px; }
        #error-toast { background: rgba(220, 38, 38, 0.9); height: auto; bottom: 20px; top: auto; border-radius: 10px; margin: 10px; inset: auto 0 20px 0; }
        
        canvas { display: none; }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

<div id="error-toast" onclick="this.style.display='none'">
    <div class="flex items-center gap-3">
        <i class="fa-solid fa-circle-exclamation"></i>
        <p id="error-msg">Bir hata oluştu!</p>
    </div>
</div>

<div id="onboarding-overlay">
    <div class="bg-zinc-900 p-6 rounded-2xl w-full max-w-sm text-center">
        <h2 class="text-2xl font-bold mb-4">Profilini Oluştur</h2>
        <div class="relative w-24 h-24 mx-auto mb-4">
            <img id="onboard-preview" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-green-500">
            <label class="absolute bottom-0 right-0 bg-green-600 p-2 rounded-full cursor-pointer">
                <i class="fa-solid fa-camera"></i>
                <input type="file" class="hidden" onchange="processImage(this, 'onboard-preview')">
            </label>
        </div>
        <input type="text" id="onboard-username" placeholder="@kullanici_adi" class="mb-3">
        <textarea id="onboard-bio" placeholder="Kendinden bahset..." class="mb-4 h-20"></textarea>
        <button onclick="completeOnboarding()" class="w-full bg-green-600 font-bold py-3 rounded-xl">Başla!</button>
    </div>
</div>

<div id="auth-screen" class="h-screen flex flex-col items-center justify-center p-6 text-center">
    <h1 class="text-6xl font-black italic mb-10 bg-gradient-to-r from-orange-500 to-purple-600 bg-clip-text text-transparent">ROF</h1>
    <button onclick="handleLogin()" class="w-full max-w-xs bg-white text-black font-bold py-4 rounded-full flex items-center justify-center gap-3">
        <img src="https://www.google.com/favicon.ico" class="w-5"> Google ile Devam Et
    </button>
</div>

<div id="app-shell" class="hidden max-w-md mx-auto min-h-screen pb-20">
    
    <header class="p-4 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur z-50">
        <h2 class="text-2xl font-black italic">ROF</h2>
        <div class="flex gap-4 items-center">
            <i class="fa-solid fa-users-viewfinder text-xl" onclick="switchTab('channels')"></i>
            <i class="fa-brands fa-whatsapp text-2xl text-green-500" onclick="switchTab('chats')"></i>
            <i class="fa-solid fa-gear text-xl text-gray-400" onclick="switchTab('settings')"></i>
        </div>
    </header>

    <section id="view-home" class="view active">
        <div id="feed-container" class="space-y-4"></div>
    </section>

    <section id="view-chats" class="view">
        <div class="flex gap-2 p-4 border-b border-zinc-800">
            <button class="flex-1 bg-zinc-800 py-2 rounded-lg text-sm">Mesajlar</button>
            <button onclick="alert('Kanal kurma yakında')" class="flex-1 bg-zinc-800 py-2 rounded-lg text-sm">Kanallar</button>
        </div>
        <div id="chat-list" class="divide-y divide-zinc-900"></div>
    </section>

    <section id="view-profile" class="view">
        <div id="profile-ui"></div>
        <div id="profile-links" class="p-4 flex flex-wrap gap-2"></div>
        <div id="profile-posts" class="grid grid-cols-3 gap-1 px-1"></div>
    </section>

    <section id="view-settings" class="view p-6">
        <h2 class="text-2xl font-bold mb-6">Ayarlar</h2>
        <div class="space-y-4">
            <div class="bg-zinc-900 p-4 rounded-xl">
                <p class="text-sm text-gray-500 mb-1">Sosyal Medya Linkleri</p>
                <input type="text" id="set-twitter" placeholder="Twitter URL" class="mb-2">
                <input type="text" id="set-youtube" placeholder="YouTube URL" class="mb-2">
                <button onclick="updateSocialLinks()" class="text-xs bg-blue-600 px-3 py-1 rounded">Kaydet</button>
            </div>
            <button onclick="handleLogout()" class="w-full bg-zinc-800 py-3 rounded-xl text-red-500">Çıkış Yap</button>
            <button onclick="deleteAccount()" class="w-full border border-red-900/50 py-3 rounded-xl text-red-800 text-xs">Hesabı Kalıcı Olarak Sil</button>
        </div>
    </section>

    <section id="view-chat-room" class="view fixed inset-0 z-[100] bg-black">
        <div class="h-full flex flex-col">
            <div class="p-4 bg-zinc-900 flex items-center gap-3">
                <i class="fa-solid fa-arrow-left" onclick="switchTab('chats')"></i>
                <img id="cr-img" class="w-10 h-10 rounded-full object-cover">
                <b id="cr-name">Yükleniyor</b>
            </div>
            <div id="cr-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-[url('https://i.ibb.co/3S6m8m0/bg.png')]"></div>
            <div class="p-3 bg-zinc-900 flex gap-2">
                <input type="text" id="cr-input" class="flex-1" placeholder="Mesaj...">
                <button onclick="sendMsg()" class="bg-green-600 w-12 h-12 rounded-full"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </section>

    <nav class="fixed bottom-0 w-full max-w-md bg-black/90 border-t border-zinc-900 flex justify-around p-4">
        <i class="fa-solid fa-house text-xl" onclick="switchTab('home')"></i>
        <i class="fa-solid fa-magnifying-glass text-xl" onclick="switchTab('search')"></i>
        <i class="fa-solid fa-circle-plus text-3xl text-white" onclick="alert('Paylaşım yakında')"></i>
        <i class="fa-solid fa-clapperboard text-xl"></i>
        <img id="nav-avatar" src="" class="w-6 h-6 rounded-full" onclick="loadMyProfile()">
    </nav>
</div>

<canvas id="compress-canvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCTHfXRbJaUcN0ng-ik0B-N4Ai8pnnKiIk",
        authDomain: "rate-of-fire-rof.firebaseapp.com",
        projectId: "rate-of-fire-rof",
        storageBucket: "rate-of-fire-rof.firebasestorage.app",
        messagingSenderId: "706117316470",
        appId: "1:706117316470:web:833f1abf5994f96c0b5457"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let me = null;
    let activeChatId = null;
    let tempImg = null;

    // ERROR HANDLER
    const report = (msg) => {
        document.getElementById('error-msg').innerText = msg;
        document.getElementById('error-toast').style.display = 'block';
        setTimeout(() => document.getElementById('error-toast').style.display = 'none', 4000);
    };

    // AUTH
    window.handleLogin = () => signInWithPopup(auth, provider).catch(e => report("Giriş başarısız!"));
    window.handleLogout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "users", user.uid));
            if (!snap.exists() || !snap.data().username) {
                document.getElementById('onboarding-overlay').style.display = 'flex';
                document.getElementById('auth-screen').style.display = 'none';
            } else {
                me = snap.data();
                startApp();
            }
        } else {
            document.getElementById('app-shell').classList.add('hidden');
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    // ONBOARDING (Kayıt Tamamlama)
    window.completeOnboarding = async () => {
        const nick = document.getElementById('onboard-username').value.trim();
        const bio = document.getElementById('onboard-bio').value;
        if (nick.length < 3) return report("Kullanıcı adı çok kısa!");

        try {
            const userData = {
                uid: auth.currentUser.uid,
                name: auth.currentUser.displayName,
                username: nick.startsWith('@') ? nick : '@' + nick,
                bio: bio || "Merhaba!",
                photo: tempImg || auth.currentUser.photoURL,
                links: { twitter: "", youtube: "" },
                followers: [], following: []
            };
            await setDoc(doc(db, "users", auth.currentUser.uid), userData);
            location.reload();
        } catch (e) { report("Kayıt sırasında hata oluştu!"); }
    };

    function startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('onboarding-overlay').style.display = 'none';
        document.getElementById('app-shell').classList.remove('hidden');
        document.getElementById('nav-avatar').src = me.photo;
        loadFeed();
        listenChats();
    }

    // FEED
    function loadFeed() {
        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snaps) => {
            const cont = document.getElementById('feed-container');
            cont.innerHTML = "";
            snaps.forEach(s => {
                const p = s.data();
                cont.innerHTML += `
                    <div class="p-4 border-b border-zinc-900">
                        <div class="flex items-center gap-3 mb-2" onclick="openProfile('${p.uid}')">
                            <img src="${p.photo}" class="w-10 h-10 rounded-full object-cover">
                            <b>${p.name}</b>
                        </div>
                        <p class="text-zinc-300">${p.text}</p>
                        ${p.image ? `<img src="${p.image}" class="mt-3 rounded-xl w-full">` : ''}
                    </div>
                `;
            });
        });
    }

    // WHATSAPP CHAT
    window.openChat = (uid, name, photo) => {
        const id = me.uid < uid ? me.uid + "_" + uid : uid + "_" + me.uid;
        activeChatId = id;
        document.getElementById('cr-name').innerText = name;
        document.getElementById('cr-img').src = photo;
        switchTab('chat-room');
        
        onSnapshot(query(collection(db, "chats", id, "messages"), orderBy("timestamp", "asc")), (snaps) => {
            const area = document.getElementById('cr-messages');
            area.innerHTML = "";
            snaps.forEach(m => {
                const d = m.data();
                const isMe = d.senderId === me.uid;
                area.innerHTML += `<div class="chat-bubble ${isMe ? 'bubble-me' : 'bubble-you'}">${d.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    };

    window.sendMsg = async () => {
        const inp = document.getElementById('cr-input');
        if (!inp.value) return;
        await addDoc(collection(db, "chats", activeChatId, "messages"), {
            text: inp.value, senderId: me.uid, timestamp: serverTimestamp()
        });
        inp.value = "";
    };

    function listenChats() {
        onSnapshot(query(collection(db, "chats"), where("users", "array-contains", auth.currentUser.uid)), (snaps) => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snaps.forEach(doc => {
                const data = doc.data();
                const otherId = data.users.find(u => u !== me.uid);
                // Not: userInfo sistemini önceki koddan miras alıyoruz
                list.innerHTML += `<div onclick="openChat('${otherId}', 'Kullanıcı', '')" class="p-4 hover:bg-zinc-900">Sohbeti Aç</div>`;
            });
        });
    }

    // PROFİL & AYARLAR
    window.loadMyProfile = async () => {
        switchTab('profile');
        const ui = document.getElementById('profile-ui');
        ui.innerHTML = `
            <div class="p-6 text-center">
                <img src="${me.photo}" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-zinc-800">
                <h2 class="text-xl font-bold">${me.name}</h2>
                <p class="text-gray-500">${me.username}</p>
                <p class="mt-2 text-sm">${me.bio}</p>
            </div>
        `;
        // Linkleri Göster
        const links = document.getElementById('profile-links');
        links.innerHTML = "";
        if(me.links?.twitter) links.innerHTML += `<a href="${me.links.twitter}" class="bg-blue-400/20 text-blue-400 px-4 py-1 rounded-full text-xs">Twitter</a>`;
        if(me.links?.youtube) links.innerHTML += `<a href="${me.links.youtube}" class="bg-red-400/20 text-red-400 px-4 py-1 rounded-full text-xs">YouTube</a>`;
    };

    window.updateSocialLinks = async () => {
        const tw = document.getElementById('set-twitter').value;
        const yt = document.getElementById('set-youtube').value;
        await updateDoc(doc(db, "users", me.uid), {
            "links.twitter": tw, "links.youtube": yt
        });
        report("Linkler güncellendi!");
    };

    window.deleteAccount = async () => {
        if(confirm("Tüm verilerin silinecek. Emin misin?")) {
            await deleteDoc(doc(db, "users", me.uid));
            await deleteUser(auth.currentUser);
            location.reload();
        }
    };

    // UTILS (Image Process)
    window.processImage = (input, previewId) => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.getElementById('compress-canvas');
                const ctx = cvs.getContext('2d');
                cvs.width = 300; cvs.height = 300;
                ctx.drawImage(img, 0, 0, 300, 300);
                tempImg = cvs.toDataURL('image/jpeg', 0.7);
                document.getElementById(previewId).src = tempImg;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
    };

</script>
</body>
</html>