<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROF BETA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; max-width: 500px; background: white; border-top: 1px solid #efefef; display: flex; justify-content: space-around; padding: 12px; z-index: 1000; }
        .view { display: none; padding-bottom: 80px; }
        .view.active { display: block; }
        .story-ring { background: linear-gradient(45deg, #f09433, #dc2743, #bc1888); padding: 2px; border-radius: 50%; width: 66px; height: 66px; }
        .active-tab { color: #ef4444 !important; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 flex justify-center min-h-screen">

    <div class="w-full max-w-[500px] bg-white shadow-2xl relative min-h-screen">
        
        <header class="sticky top-0 bg-white/90 backdrop-blur-md z-[110] border-b p-4 flex justify-between items-center">
            <h1 class="text-3xl font-black italic tracking-tighter text-red-600">ROF<span class="text-[10px] bg-red-600 text-white px-1 ml-1 rounded">BETA</span></h1>
            <div id="header-icons" class="flex gap-4 items-center">
                <i class="fa-regular fa-heart text-xl"></i>
                <i class="fa-regular fa-paper-plane text-xl"></i>
            </div>
        </header>

        <section id="home" class="view active">
            <div id="stories" class="flex gap-4 p-4 overflow-x-auto bg-white border-b">
                <div class="flex flex-col items-center gap-1 min-w-[70px]">
                    <div class="story-ring"><img id="me-story" src="" class="w-full h-full rounded-full border-2 border-white object-cover"></div>
                    <span class="text-[10px] text-gray-500">Hikayen</span>
                </div>
            </div>

            <div class="p-4 border-b">
                <div class="flex gap-3">
                    <img id="post-avatar" src="" class="w-10 h-10 rounded-full">
                    <div class="flex-1">
                        <textarea id="postText" placeholder="Neler oluyor?" class="w-full border-none outline-none text-lg resize-none" rows="2"></textarea>
                        <input type="text" id="postImg" placeholder="G√∂rsel URL (ƒ∞steƒüe baƒülƒ±)" class="w-full text-xs bg-gray-100 p-2 rounded-lg mt-2 outline-none">
                        <div class="flex justify-end mt-2"><button onclick="firePost()" class="bg-red-600 text-white px-6 py-1.5 rounded-full font-bold text-sm">ATE≈ûLE</button></div>
                    </div>
                </div>
            </div>

            <div id="feed" class="divide-y"></div>
        </section>

        <section id="explore" class="view">
            <div class="p-4">
                <div class="bg-gray-100 flex items-center p-3 rounded-2xl mb-4">
                    <i class="fa fa-search text-gray-400 mr-2"></i>
                    <input type="text" id="searchInput" oninput="searchUsers(this.value)" placeholder="Kullanƒ±cƒ± ara..." class="bg-transparent outline-none w-full">
                </div>
                <div id="search-results" class="space-y-4 mb-6"></div>
                <div class="grid grid-cols-3 gap-1" id="explore-grid"></div>
            </div>
        </section>

        <section id="profile" class="view">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <img id="pro-img" src="" class="w-20 h-20 rounded-full border-2 border-red-500 p-0.5">
                    <div class="flex gap-6 text-center">
                        <div><b id="p-posts">0</b><br><span class="text-xs text-gray-400">Post</span></div>
                        <div><b id="p-followers">0</b><br><span class="text-xs text-gray-400">Takip√ßi</span></div>
                        <div><b id="p-following">0</b><br><span class="text-xs text-gray-400">Takip</span></div>
                    </div>
                </div>
                <h2 id="pro-name" class="font-bold text-lg leading-none"></h2>
                <p id="pro-bio" class="text-sm text-gray-600 mt-2">ROF Kullanƒ±cƒ±sƒ±</p>
                <button onclick="openEditProfile()" class="w-full bg-gray-100 py-2 rounded-lg font-bold text-sm mt-4">Profili D√ºzenle</button>
                <div class="grid grid-cols-3 gap-1 mt-8" id="profile-grid"></div>
            </div>
        </section>

        <nav class="nav-bottom">
            <button onclick="switchTab('home', this)" class="active-tab"><i class="fa-solid fa-house text-xl"></i></button>
            <button onclick="switchTab('explore', this)"><i class="fa-solid fa-magnifying-glass text-xl"></i></button>
            <button onclick="switchTab('profile', this)"><i class="fa-solid fa-user text-xl"></i></button>
        </nav>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, getDocs, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTHfXRbJaUcN0ng-ik0B-N4Ai8pnnKiIk",
            authDomain: "rate-of-fire-rof.firebaseapp.com",
            projectId: "rate-of-fire-rof",
            storageBucket: "rate-of-fire-rof.firebasestorage.app",
            messagingSenderId: "706117316470",
            appId: "1:706117316470:web:833f1abf5994f96c0b5457"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let userData = null;

        // AUTH & DATABASE SYNC
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        uid: user.uid,
                        name: user.displayName,
                        photo: user.photoURL,
                        bio: "ROF Macerasƒ± Ba≈üladƒ±!",
                        followers: [],
                        following: []
                    });
                }
                userData = (await getDoc(userRef)).data();
                initApp();
            } else {
                signInWithPopup(auth, provider);
            }
        });

        function initApp() {
            document.getElementById('me-story').src = userData.photo;
            document.getElementById('post-avatar').src = userData.photo;
            document.getElementById('pro-img').src = userData.photo;
            document.getElementById('pro-name').innerText = userData.name;
            document.getElementById('pro-bio').innerText = userData.bio;
            document.getElementById('p-followers').innerText = userData.followers.length;
            document.getElementById('p-following').innerText = userData.following.length;
            loadFeed();
        }

        // POST ATMA
        window.firePost = async () => {
            const txt = document.getElementById('postText').value;
            const img = document.getElementById('postImg').value;
            if(!txt && !img) return;
            await addDoc(collection(db, "posts"), {
                uid: userData.uid,
                name: userData.name,
                photo: userData.photo,
                text: txt,
                image: img || null,
                likes: [],
                comments: [],
                time: serverTimestamp()
            });
            document.getElementById('postText').value = "";
            document.getElementById('postImg').value = "";
        };

        // AKI≈û VE YORUMLAR
        function loadFeed() {
            const q = query(collection(db, "posts"), orderBy("time", "desc"));
            onSnapshot(q, (snaps) => {
                const feed = document.getElementById('feed');
                const pGrid = document.getElementById('profile-grid');
                feed.innerHTML = ""; pGrid.innerHTML = "";
                let pCount = 0;

                snaps.forEach(s => {
                    const p = s.data();
                    const id = s.id;
                    const isLiked = p.likes.includes(userData.uid);
                    if(p.uid === userData.uid) {
                        pCount++;
                        if(p.image) pGrid.innerHTML += `<img src="${p.image}" class="aspect-square object-cover w-full">`;
                    }

                    feed.innerHTML += `
                        <div class="p-4 bg-white">
                            <div class="flex items-center gap-2 mb-3">
                                <img src="${p.photo}" class="w-8 h-8 rounded-full border">
                                <span class="font-bold text-sm">${p.name}</span>
                            </div>
                            ${p.image ? `<img src="${p.image}" class="w-full rounded-xl mb-3 shadow-sm border">` : ''}
                            <p class="text-[15px]">${p.text}</p>
                            <div class="flex gap-6 mt-4 text-xl">
                                <button onclick="like('${id}', ${isLiked})">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                                <button onclick="addComment('${id}')">üí¨</button>
                            </div>
                            <div class="mt-2 text-xs font-bold">${p.likes.length} beƒüeni ‚Ä¢ ${p.comments.length} yorum</div>
                            <div class="mt-2 space-y-1">
                                ${p.comments.slice(-2).map(c => `<p class="text-xs"><b>${c.user}:</b> ${c.text}</p>`).join('')}
                            </div>
                        </div>`;
                });
                document.getElementById('p-posts').innerText = pCount;
            });
        }

        // Lƒ∞KE & YORUM FONKSƒ∞YONLARI
        window.like = async (id, s) => {
            await updateDoc(doc(db, "posts", id), { likes: s ? arrayRemove(userData.uid) : arrayUnion(userData.uid) });
        };

        window.addComment = async (id) => {
            const cText = prompt("Yorumun:");
            if(cText) await updateDoc(doc(db, "posts", id), { 
                comments: arrayUnion({ user: userData.name, text: cText }) 
            });
        };

        // ARAMA Sƒ∞STEMƒ∞
        window.searchUsers = async (val) => {
            if(val.length < 2) return;
            const q = query(collection(db, "users"), where("name", ">=", val));
            const snaps = await getDocs(q);
            const res = document.getElementById('search-results');
            res.innerHTML = "";
            snaps.forEach(u => {
                const d = u.data();
                if(d.uid === userData.uid) return;
                const isFollowing = userData.following.includes(d.uid);
                res.innerHTML += `
                    <div class="flex items-center justify-between p-2 border-b">
                        <div class="flex items-center gap-3">
                            <img src="${d.photo}" class="w-10 h-10 rounded-full">
                            <b class="text-sm">${d.name}</b>
                        </div>
                        <button onclick="follow('${d.uid}', ${isFollowing})" class="${isFollowing ? 'bg-gray-200 text-black' : 'bg-blue-500 text-white'} px-4 py-1 rounded-lg text-xs font-bold">
                            ${isFollowing ? 'Takiptesin' : 'Takip Et'}
                        </button>
                    </div>`;
            });
        };

        // TAKƒ∞P ETME
        window.follow = async (targetUid, isFollowing) => {
            const myRef = doc(db, "users", userData.uid);
            const targetRef = doc(db, "users", targetUid);
            if(isFollowing) {
                await updateDoc(myRef, { following: arrayRemove(targetUid) });
                await updateDoc(targetRef, { followers: arrayRemove(userData.uid) });
            } else {
                await updateDoc(myRef, { following: arrayUnion(targetUid) });
                await updateDoc(targetRef, { followers: arrayUnion(userData.uid) });
            }
            location.reload();
        };

        window.openEditProfile = async () => {
            const nBio = prompt("Yeni Bionuz:", userData.bio);
            if(nBio) {
                await updateDoc(doc(db, "users", userData.uid), { bio: nBio });
                location.reload();
            }
        };

        window.switchTab = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            el.classList.add('active-tab');
        };

    </script>
</body>
</html>

